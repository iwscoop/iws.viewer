var resample={debug:false};self.addEventListener("message",onmessage,false);Filters={};if(typeof Float32Array=="undefined"){Filters.getFloat32Array=Filters.getUint8Array=function(a){if(a.length){return a.slice(0)}return new Array(a)}}else{Filters.getFloat32Array=function(a){return new Float32Array(a)};Filters.getUint8Array=function(a){return new Uint8Array(a)}}Filters.getPixels=function(a){return a};Filters.createImageData=function(a,r){return{data:new Uint8Array(a*r*4),width:a,height:r}};Filters.filterImage=function(a,r,t){var e=[this.getPixels(r)];for(var v=2;v<arguments.length;v++){e.push(arguments[v])}return a.apply(this,e)};Filters.toImageData=function(a){return this.identity(a)};Filters.runPipeline=function(a){var r=null;r=this[a[0].name].apply(this,a[0].args);for(var t=1;t<a.length;t++){var e=a[t];var v=e.args.slice(0);v.unshift(r);r=this[e.name].apply(this,v)}return r};Filters.createImageDataFloat32=function(a,r){return{width:a,height:r,data:this.getFloat32Array(a*r*4)}};Filters.identity=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=t.data;var v=a.data;for(var i=0;i<v.length;i++){e[i]=v[i]}return t};Filters.horizontalFlip=function(a){var r=Filters.createImageData(a.width,a.height);var t=a.width;var e=a.height;var v=r.data;var i=a.data;for(var n=0;n<e;n++){for(var l=0;l<t;l++){var h=(n*t+l)*4;var o=(n*t+(t-l-1))*4;v[o]=i[h];v[o+1]=i[h+1];v[o+2]=i[h+2];v[o+3]=i[h+3]}}return r};Filters.verticalFlip=function(a){var r=Filters.createImageData(a.width,a.height);var t=a.width;var e=a.height;var v=r.data;var i=a.data;for(var n=0;n<e;n++){for(var l=0;l<t;l++){var h=(n*t+l)*4;var o=((e-n-1)*t+l)*4;v[o]=i[h];v[o+1]=i[h+1];v[o+2]=i[h+2];v[o+3]=i[h+3]}}return r};Filters.luminance=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=t.data;var v=a.data;for(var i=0;i<v.length;i+=4){var n=v[i];var l=v[i+1];var h=v[i+2];var o=.2126*n+.7152*l+.0722*h;e[i]=e[i+1]=e[i+2]=o;e[i+3]=v[i+3]}return t};Filters.grayscale=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=t.data;var v=a.data;for(var i=0;i<v.length;i+=4){var n=v[i];var l=v[i+1];var h=v[i+2];var o=.3*n+.59*l+.11*h;e[i]=e[i+1]=e[i+2]=o;e[i+3]=v[i+3]}return t};Filters.grayscaleAvg=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=t.data;var v=a.data;var i=1/3;for(var n=0;n<v.length;n+=4){var l=v[n];var h=v[n+1];var o=v[n+2];var s=(l+h+o)*i;e[n]=e[n+1]=e[n+2]=s;e[n+3]=v[n+3]}return t};Filters.threshold=function(a,r,t,e){var v=Filters.createImageData(a.width,a.height);if(t==null)t=255;if(e==null)e=0;var i=a.data;var n=v.data;for(var l=0;l<i.length;l+=4){var h=i[l];var o=i[l+1];var s=i[l+2];var d=.3*h+.59*o+.11*s>=r?t:e;n[l]=n[l+1]=n[l+2]=d;n[l+3]=i[l+3]}return v};Filters.invert=function(a){var r=Filters.createImageData(a.width,a.height);var t=a.data;var e=r.data;for(var v=0;v<t.length;v+=4){e[v]=255-t[v];e[v+1]=255-t[v+1];e[v+2]=255-t[v+2];e[v+3]=t[v+3]}return r};Filters.brightnessContrast=function(a,r,t){var e=this.brightnessContrastLUT(r,t);return this.applyLUT(a,{r:e,g:e,b:e,a:this.identityLUT()})};Filters.applyLUT=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=t.data;var i=r.r;var n=r.g;var l=r.b;var h=r.a;for(var o=0;o<e.length;o+=4){v[o]=i[e[o]];v[o+1]=n[e[o+1]];v[o+2]=l[e[o+2]];v[o+3]=h[e[o+3]]}return t};Filters.createLUTFromCurve=function(a){var r=this.getUint8Array(256);var t=[0,0];for(var e=0,v=0;e<r.length;e++){while(v<a.length&&a[v][0]<e){t=a[v];v++}r[e]=t[1]}return r};Filters.identityLUT=function(){var a=this.getUint8Array(256);for(var r=0;r<a.length;r++){a[r]=r}return a};Filters.invertLUT=function(){var a=this.getUint8Array(256);for(var r=0;r<a.length;r++){a[r]=255-r}return a};Filters.brightnessContrastLUT=function(a,r){var t=this.getUint8Array(256);var e=-128*r+128;var v=255*a;var i=e+v;for(var n=0;n<t.length;n++){var l=n*r+i;t[n]=l<0?0:l>255?255:l}return t};Filters.convolve=function(a,r,t){var e=Math.round(Math.sqrt(r.length));var v=Math.floor(e/2);var i=a.data;var n=a.width;var l=a.height;var h=n;var o=l;var s=Filters.createImageData(h,o);var d=s.data;var g=t?1:0;for(var f=0;f<o;f++){for(var c=0;c<h;c++){var u=f;var F=c;var m=(f*h+c)*4;var w=0,M=0,b=0,p=0;for(var y=0;y<e;y++){for(var D=0;D<e;D++){var I=Math.min(l-1,Math.max(0,u+y-v));var x=Math.min(n-1,Math.max(0,F+D-v));var U=(I*n+x)*4;var A=r[y*e+D];w+=i[U]*A;M+=i[U+1]*A;b+=i[U+2]*A;p+=i[U+3]*A}}d[m]=w;d[m+1]=M;d[m+2]=b;d[m+3]=p+g*(255-p)}}return s};Filters.verticalConvolve=function(a,r,t){var e=r.length;var v=Math.floor(e/2);var i=a.data;var n=a.width;var l=a.height;var h=n;var o=l;var s=Filters.createImageData(h,o);var d=s.data;var g=t?1:0;for(var f=0;f<o;f++){for(var c=0;c<h;c++){var u=f;var F=c;var m=(f*h+c)*4;var w=0,M=0,b=0,p=0;for(var y=0;y<e;y++){var D=Math.min(l-1,Math.max(0,u+y-v));var I=F;var x=(D*n+I)*4;var U=r[y];w+=i[x]*U;M+=i[x+1]*U;b+=i[x+2]*U;p+=i[x+3]*U}d[m]=w;d[m+1]=M;d[m+2]=b;d[m+3]=p+g*(255-p)}}return s};Filters.horizontalConvolve=function(a,r,t){var e=r.length;var v=Math.floor(e/2);var i=a.data;var n=a.width;var l=a.height;var h=n;var o=l;var s=Filters.createImageData(h,o);var d=s.data;var g=t?1:0;for(var f=0;f<o;f++){for(var c=0;c<h;c++){var u=f;var F=c;var m=(f*h+c)*4;var w=0,M=0,b=0,p=0;for(var y=0;y<e;y++){var D=u;var I=Math.min(n-1,Math.max(0,F+y-v));var x=(D*n+I)*4;var U=r[y];w+=i[x]*U;M+=i[x+1]*U;b+=i[x+2]*U;p+=i[x+3]*U}d[m]=w;d[m+1]=M;d[m+2]=b;d[m+3]=p+g*(255-p)}}return s};Filters.separableConvolve=function(a,r,t,e){return this.horizontalConvolve(this.verticalConvolveFloat32(a,t,e),r,e)};Filters.convolveFloat32=function(a,r,t){var e=Math.round(Math.sqrt(r.length));var v=Math.floor(e/2);var i=a.data;var n=a.width;var l=a.height;var h=n;var o=l;var s=Filters.createImageDataFloat32(h,o);var d=s.data;var g=t?1:0;for(var f=0;f<o;f++){for(var c=0;c<h;c++){var u=f;var F=c;var m=(f*h+c)*4;var w=0,M=0,b=0,p=0;for(var y=0;y<e;y++){for(var D=0;D<e;D++){var I=Math.min(l-1,Math.max(0,u+y-v));var x=Math.min(n-1,Math.max(0,F+D-v));var U=(I*n+x)*4;var A=r[y*e+D];w+=i[U]*A;M+=i[U+1]*A;b+=i[U+2]*A;p+=i[U+3]*A}}d[m]=w;d[m+1]=M;d[m+2]=b;d[m+3]=p+g*(255-p)}}return s};Filters.verticalConvolveFloat32=function(a,r,t){var e=r.length;var v=Math.floor(e/2);var i=a.data;var n=a.width;var l=a.height;var h=n;var o=l;var s=Filters.createImageDataFloat32(h,o);var d=s.data;var g=t?1:0;for(var f=0;f<o;f++){for(var c=0;c<h;c++){var u=f;var F=c;var m=(f*h+c)*4;var w=0,M=0,b=0,p=0;for(var y=0;y<e;y++){var D=Math.min(l-1,Math.max(0,u+y-v));var I=F;var x=(D*n+I)*4;var U=r[y];w+=i[x]*U;M+=i[x+1]*U;b+=i[x+2]*U;p+=i[x+3]*U}d[m]=w;d[m+1]=M;d[m+2]=b;d[m+3]=p+g*(255-p)}}return s};Filters.horizontalConvolveFloat32=function(a,r,t){var e=r.length;var v=Math.floor(e/2);var i=a.data;var n=a.width;var l=a.height;var h=n;var o=l;var s=Filters.createImageDataFloat32(h,o);var d=s.data;var g=t?1:0;for(var f=0;f<o;f++){for(var c=0;c<h;c++){var u=f;var F=c;var m=(f*h+c)*4;var w=0,M=0,b=0,p=0;for(var y=0;y<e;y++){var D=u;var I=Math.min(n-1,Math.max(0,F+y-v));var x=(D*n+I)*4;var U=r[y];w+=i[x]*U;M+=i[x+1]*U;b+=i[x+2]*U;p+=i[x+3]*U}d[m]=w;d[m+1]=M;d[m+2]=b;d[m+3]=p+g*(255-p)}}return s};Filters.separableConvolveFloat32=function(a,r,t,e){return this.horizontalConvolveFloat32(this.verticalConvolveFloat32(a,t,e),r,e)};Filters.gaussianBlur=function(a,r){r=Math.abs(r);if(r<=1)return Filters.identity(a);var t=r/2;var e=Math.ceil(r)+(1-Math.ceil(r)%2);var v=this.getFloat32Array(e);var i=(t+.5)/3;var n=i*i;var l=1/Math.sqrt(2*Math.PI*n);var h=-1/(2*i*i);var o=0;var s=Math.floor(e/2);for(var d=0;d<e;d++){var g=d-s;var f=l*Math.exp(g*g*h);v[d]=f;o+=f}for(var d=0;d<v.length;d++){v[d]/=o}return Filters.separableConvolve(a,v,v,false)};Filters.laplaceKernel=Filters.getFloat32Array([-1,-1,-1,-1,8,-1,-1,-1,-1]);Filters.laplace=function(a){return Filters.convolve(a,this.laplaceKernel,true)};Filters.sobelSignVector=Filters.getFloat32Array([-1,0,1]);Filters.sobelScaleVector=Filters.getFloat32Array([1,2,1]);Filters.sobelVerticalGradient=function(a){return this.separableConvolveFloat32(a,this.sobelSignVector,this.sobelScaleVector)};Filters.sobelHorizontalGradient=function(a){return this.separableConvolveFloat32(a,this.sobelScaleVector,this.sobelSignVector)};Filters.sobelVectors=function(a){var r=this.sobelVerticalGradient(a);var t=this.sobelHorizontalGradient(a);var e={width:r.width,height:r.height,data:this.getFloat32Array(r.width*r.height*8)};var v=r.data;var i=t.data;var n=e.data;for(var l=0,h=0;l<n.length;l+=2,h++){n[l]=i[h];n[l+1]=v[h]}return e};Filters.sobel=function(a){a=this.grayscale(a);var r=this.sobelVerticalGradient(a);var t=this.sobelHorizontalGradient(a);var e=this.createImageData(r.width,r.height);for(var v=0;v<e.data.length;v+=4){var i=Math.abs(r.data[v]);e.data[v]=i;var n=Math.abs(t.data[v]);e.data[v+1]=n;e.data[v+2]=(i+n)/4;e.data[v+3]=255}return e};Filters.bilinearSample=function(a,r,t,e){var v=Math.floor(r);var i=Math.ceil(r);var n=Math.floor(t);var l=Math.ceil(t);var h=(v+a.width*n)*4;var o=(i+a.width*n)*4;var s=(v+a.width*l)*4;var d=(i+a.width*l)*4;var g=r-v+(t-n);var f=i-r+(t-n);var c=r-v+(l-t);var u=i-r+(l-t);var F=1/(u+c+f+g);u*=F;c*=F;f*=F;g*=F;var m=a.data;e[0]=m[h]*u+m[o]*c+m[s]*f+m[d]*g;e[1]=m[h+1]*u+m[o+1]*c+m[s+1]*f+m[d+1]*g;e[2]=m[h+2]*u+m[o+2]*c+m[s+2]*f+m[d+2]*g;e[3]=m[h+3]*u+m[o+3]*c+m[s+3]*f+m[d+3]*g;return e};Filters.distortSine=function(a,r,t){if(r==null)r=.5;if(t==null)t=r;var e=this.createImageData(a.width,a.height);var v=e.data;var i=a.data;var n=this.createImageData(1,1).data;for(var l=0;l<e.height;l++){var h=-Math.sin(l/(e.height-1)*Math.PI*2);var o=l+h*t*e.height/4;o=Math.max(Math.min(o,e.height-1),0);for(var s=0;s<e.width;s++){var d=-Math.sin(s/(e.width-1)*Math.PI*2);var g=s+d*r*e.width/4;g=Math.max(Math.min(g,e.width-1),0);var f=this.bilinearSample(a,g,o,n);var c=(l*e.width+s)*4;v[c]=f[0];v[c+1]=f[1];v[c+2]=f[2];v[c+3]=f[3]}}return e};Filters.darkenBlend=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=r.data;var i=t.data;var n=1/255;for(var l=0;l<e.length;l+=4){i[l]=e[l]<v[l]?e[l]:v[l];i[l+1]=e[l+1]<v[l+1]?e[l+1]:v[l+1];i[l+2]=e[l+2]<v[l+2]?e[l+2]:v[l+2];i[l+3]=e[l+3]+(255-e[l+3])*v[l+3]*n}return t};Filters.lightenBlend=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=r.data;var i=t.data;var n=1/255;for(var l=0;l<e.length;l+=4){i[l]=e[l]>v[l]?e[l]:v[l];i[l+1]=e[l+1]>v[l+1]?e[l+1]:v[l+1];i[l+2]=e[l+2]>v[l+2]?e[l+2]:v[l+2];i[l+3]=e[l+3]+(255-e[l+3])*v[l+3]*n}return t};Filters.multiplyBlend=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=r.data;var i=t.data;var n=1/255;for(var l=0;l<e.length;l+=4){i[l]=e[l]*v[l]*n;i[l+1]=e[l+1]*v[l+1]*n;i[l+2]=e[l+2]*v[l+2]*n;i[l+3]=e[l+3]+(255-e[l+3])*v[l+3]*n}return t};Filters.screenBlend=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=r.data;var i=t.data;var n=1/255;for(var l=0;l<e.length;l+=4){i[l]=e[l]+v[l]-e[l]*v[l]*n;i[l+1]=e[l+1]+v[l+1]-e[l+1]*v[l+1]*n;i[l+2]=e[l+2]+v[l+2]-e[l+2]*v[l+2]*n;i[l+3]=e[l+3]+(255-e[l+3])*v[l+3]*n}return t};Filters.addBlend=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=r.data;var i=t.data;var n=1/255;for(var l=0;l<e.length;l+=4){i[l]=e[l]+v[l];i[l+1]=e[l+1]+v[l+1];i[l+2]=e[l+2]+v[l+2];i[l+3]=e[l+3]+(255-e[l+3])*v[l+3]*n}return t};Filters.subBlend=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=r.data;var i=t.data;var n=1/255;for(var l=0;l<e.length;l+=4){i[l]=e[l]+v[l]-255;i[l+1]=e[l+1]+v[l+1]-255;i[l+2]=e[l+2]+v[l+2]-255;i[l+3]=e[l+3]+(255-e[l+3])*v[l+3]*n}return t};Filters.differenceBlend=function(a,r){var t=Filters.createImageData(a.width,a.height);var e=a.data;var v=r.data;var i=t.data;var n=1/255;for(var l=0;l<e.length;l+=4){i[l]=Math.abs(e[l]-v[l]);i[l+1]=Math.abs(e[l+1]-v[l+1]);i[l+2]=Math.abs(e[l+2]-v[l+2]);i[l+3]=e[l+3]+(255-e[l+3])*v[l+3]*n}return t};Filters.erode=function(a){var r=a.data;var t=a.width;var e=a.height;var v=t;var i=e;var n=Filters.createImageData(v,i);var l=n.data;for(var h=0;h<i;h++){for(var o=0;o<v;o++){var s=h;var d=o;var g=(h*v+o)*4;var f=(s*t+d)*4;var c=0;if(r[f]==0){if(r[(s*t+Math.max(0,d-1))*4]==0&&r[(Math.max(0,s-1)*t+d)*4]==0){c=255}}else{c=255}l[g]=c;l[g+1]=c;l[g+2]=c;l[g+3]=255}}return n};if(typeof require!="undefined"){exports.Filters=Filters}function resize(a,r,t,e){var v=0,i=0,n=0,l=0,h=a/t,o=r/e,s=Math.max(h,o);if(s>1){v=a/s;i=r/s}else{v=a;i=r}n=(t-v)/2;l=(e-i)/2;return{w:v,h:i,x:n,y:l}}function resample_hermite(a,r,t,e,v,i){var n=t/v;var l=e/i;var h=Math.ceil(n/1);var o=Math.ceil(l/1);for(var s=0;s<i;s++){for(var d=0;d<v;d++){var g=(d+s*v)*4;var f=0;var c=0;var u=0;var F=gx_g=gx_b=gx_a=0;var m=(s+.5)*l;for(var w=Math.floor(s*l);w<(s+1)*l;w++){var M=Math.abs(m-(w+.5))/o;var b=(d+.5)*n;var p=M*M;for(var y=Math.floor(d*n);y<(d+1)*n;y++){var D=Math.abs(b-(y+.5))/h;var I=Math.sqrt(p+D*D);if(I>=-1&&I<=1){f=2*I*I*I-3*I*I+1;if(f>0){D=4*(y+w*t);gx_a+=f*a[D+3];u+=f;if(a[D+3]<255)f=f*a[D+3]/250;F+=f*a[D];gx_g+=f*a[D+1];gx_b+=f*a[D+2];c+=f}}}}r[g]=F/c;r[g+1]=gx_g/c;r[g+2]=gx_b/c;r[g+3]=gx_a/u}}}var scaledData=null;onmessage=function(a){var r=Date.now();var t=a.data.cmd;switch(t){case"page-set":{scaledData=a.data.imageData;postMessage({cmd:t,w:scaledData.width,h:scaledData.height});resample.debug&&console.log("iws.w.resample.js : page-set   >>>>    "+(Date.now()-r)/1e3+" Seconds")}break;case"resampling":{var e=a.data.w;var v=a.data.h;var i=new Uint8Array(e*v*4);resample_hermite(scaledData.data,i,scaledData.width,scaledData.height,e,v);var n={data:i,width:e,height:v};switch(a.data.filter){case"none":{}break;case"convolveFloat32":{var l={r:Filters.identityLUT(),g:Filters.identityLUT(),b:Filters.identityLUT(),a:Filters.identityLUT()};var h=Filters.filterImage(Filters.applyLUT,n,l);n=h;var h=Filters.filterImage(Filters.convolveFloat32,n,[0,-1,0,-1,5,-1,0,-1,0]);n=h}break}postMessage({cmd:t,w:e,h:v,bytearray:n.data});resample.debug&&console.log("iws.w.resample.js : resampling >>>>    "+(Date.now()-r)/1e3+" Seconds ("+e+", "+v+")")}break;default:{console.log("Don't know command.")}break}};