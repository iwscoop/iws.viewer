var last_ms=Date.now();importScripts("./IWSImageLib_min.js");var importtime=(Date.now()-last_ms)/1e3+" Seconds";function resize(e,a,r,t){var n=0,s=0,i=0,g=0,l=e/r,m=a/t,f=Math.max(l,m);if(f>1){n=e/f;s=a/f}else{n=e;s=a}i=(r-n)/2;g=(t-s)/2;return{w:n,h:s,x:i,y:g}}function resample_hermite(e,a,r,t,n,s){var i=r/n;var g=t/s;var l=Math.ceil(i/3);var m=Math.ceil(g/3);for(var f=0;f<s;f++){for(var o=0;o<n;o++){var v=(o+f*n)*4;var b=0;var I=0;var h=0;var d=gx_g=gx_b=gx_a=0;var c=(f+.5)*g;for(var y=Math.floor(f*g);y<(f+1)*g;y++){var u=Math.abs(c-(y+.5))/m;var p=(o+.5)*i;var w=u*u;for(var L=Math.floor(o*i);L<(o+1)*i;L++){var _=Math.abs(p-(L+.5))/l;var S=Math.sqrt(w+_*_);if(S>=-1&&S<=1){b=2*S*S*S-3*S*S+1;if(b>0){_=4*(L+y*r);gx_a+=b*e[_+3];h+=b;if(e[_+3]<255)b=b*e[_+3]/250;d+=b*e[_];gx_g+=b*e[_+1];gx_b+=b*e[_+2];I+=b}}}}a[v]=d/I;a[v+1]=gx_g/I;a[v+2]=gx_b/I;a[v+3]=gx_a/h}}}function LoadImage(e){var a=IWSImageLib._malloc(e.byteLength);var r=new Uint8Array(IWSImageLib.HEAPU8.buffer,a,e.byteLength);r.set(new Uint8Array(e));var t=new IWSImageLib.CIWSImageWeb;var n=Date.now();var s=t.DecodeInfomation(r.byteOffset,r.byteLength,1);var i={width:t.GetImageWidth(),height:t.GetImageHeight(),bpp:t.GetBitperpixel(),xres:t.GetXresolution(),yres:t.GetYresolution()};var g=null;var l=null;var m=i.width*i.height*4;var f=false;if(i.bpp<=8){var o=i.width*i.height;var v=IWSImageLib._malloc(o);var b=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,v,o);f=t.DecodeImage(r.byteOffset,r.byteLength,1,b.byteOffset);if(f==1){l=IWSImageLib._malloc(m);g=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,l,m);t.SetRowData(g.byteOffset)}IWSImageLib._free(v);v=null;b=null}else{l=IWSImageLib._malloc(m);g=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,l,m);f=t.DecodeImage(r.byteOffset,r.byteLength,1,g.byteOffset)}IWSImageLib._free(a);a=null;r=null;t.DeleteImageEx();t=null;return{pageInfo:i,rowData:g}}self.addEventListener("message",onmessage,false);onmessage=function(e){var a=e.data.cmd;var r=e.data.buffer;var t=e.data.id;var n=e.data.pageArray;switch(a){case"loadAndMakeThumb":{var s=LoadImage(r);var i=s.pageInfo,g=s.rowData;var l=resize(i.width,i.height,200,200);var m=Math.round(l.w);var f=Math.round(l.h);var o=new Uint8Array(m*f*4);resample_hermite(g,o,i.width,i.height,m,f);var v=null;postMessage({cmd:a,id:t,bytearray:o,xsize:m,ysize:f,pagearray:v,pageInfo:i,maketime:(Date.now()-last_ms)/1e3});v=null;IWSImageLib._free(g.byteOffset);g=null}break;case"loadpage":{var s=LoadImage(r);var i=s.pageInfo,g=s.rowData;var v=new Uint8Array(g.byteLength);v.set(g);postMessage({cmd:a,id:t,pagearray:v,pageInfo:i,maketime:(Date.now()-last_ms)/1e3});v=null;IWSImageLib._free(g.byteOffset);g=null}break;case"savepage":{var b=e.data.format;var I=0,h=1,d=2,c=3,y=4,u=5,p=6,w=7;var L=0,_=2,S=3,W=4,D=5,k=6,x=7,A=32773;var s=LoadImage(r);var i=s.pageInfo,g=s.rowData;var M=new IWSImageLib.CIWSImageWeb;var U=0;var O=100;switch(b){case h:U=L;O=100;break;case d:O=20;break;case c:O=20;if(i.bpp===1)U=W;else U=x;break;case y:O=20;break;case u:O=20;break;case p:break;case w:break}var E=M.EncodeImage(g.byteOffset,g.byteLength,i.width,i.height,i.bpp,i.xres,i.yres,b,U,O,t.angle);IWSImageLib._free(g.byteOffset);g=null;var C=null;var G=false;if(E==1){var H=M.GetImageSize();var z=IWSImageLib._malloc(H);saveData=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,z,H);var P=M.GetImageData(saveData.byteOffset);if(P==1){C=new Uint8Array(saveData.byteLength);C.set(saveData);G=true;M.EncodeClose()}IWSImageLib._free(z);z=null}postMessage({cmd:a,id:t,filearray:C,success:G,maketime:(Date.now()-last_ms)/1e3});C=null;M=null}break;default:console.log("Don't know command.");break}};