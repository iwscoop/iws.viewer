var last_ms=Date.now();importScripts("./IWSImageLib_min.js");var importtime=(Date.now()-last_ms)/1e3+" Seconds";function resize(e,a,r,t){var s=0,n=0,i=0,g=0,l=e/r,f=a/t,m=Math.max(l,f);if(m>1){s=e/m;n=a/m}else{s=e;n=a}i=(r-s)/2;g=(t-n)/2;return{w:s,h:n,x:i,y:g}}function resample_hermite(e,a,r,t,s,n){var i=r/s;var g=t/n;var l=Math.ceil(i/3);var f=Math.ceil(g/3);for(var m=0;m<n;m++){for(var o=0;o<s;o++){var b=(o+m*s)*4;var v=0;var I=0;var h=0;var d=gx_g=gx_b=gx_a=0;var y=(m+.5)*g;for(var c=Math.floor(m*g);c<(m+1)*g;c++){var u=Math.abs(y-(c+.5))/f;var w=(o+.5)*i;var p=u*u;for(var L=Math.floor(o*i);L<(o+1)*i;L++){var _=Math.abs(w-(L+.5))/l;var S=Math.sqrt(p+_*_);if(S>=-1&&S<=1){v=2*S*S*S-3*S*S+1;if(v>0){_=4*(L+c*r);gx_a+=v*e[_+3];h+=v;if(e[_+3]<255)v=v*e[_+3]/250;d+=v*e[_];gx_g+=v*e[_+1];gx_b+=v*e[_+2];I+=v}}}}a[b]=d/I;a[b+1]=gx_g/I;a[b+2]=gx_b/I;a[b+3]=gx_a/h}}}function LoadImage(e){var a=IWSImageLib._malloc(e.byteLength);var r=new Uint8Array(IWSImageLib.HEAPU8.buffer,a,e.byteLength);r.set(new Uint8Array(e));var t=new IWSImageLib.CIWSImageWeb;var s=Date.now();var n=t.DecodeInfomation(r.byteOffset,r.byteLength,1);var i={width:t.GetImageWidth(),height:t.GetImageHeight(),bpp:t.GetBitperpixel(),xres:t.GetXresolution(),yres:t.GetYresolution()};var g=null;var l=null;var f=i.width*i.height*4;var m=false;if(i.bpp<=8){var o=i.width*i.height;var b=IWSImageLib._malloc(o);var v=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,b,o);m=t.DecodeImage(r.byteOffset,r.byteLength,1,v.byteOffset);if(m==1){l=IWSImageLib._malloc(f);g=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,l,f);t.SetRowData(g.byteOffset)}IWSImageLib._free(b);b=null;v=null}else{l=IWSImageLib._malloc(f);g=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,l,f);m=t.DecodeImage(r.byteOffset,r.byteLength,1,g.byteOffset);t.SetRowData(g.byteOffset)}IWSImageLib._free(a);a=null;r=null;t.DeleteImageEx();t=null;return{pageInfo:i,rowData:g}}self.addEventListener("message",onmessage,false);onmessage=function(e){var a=e.data.cmd;var r=e.data.buffer;var t=e.data.id;var s=e.data.pageArray;switch(a){case"loadAndMakeThumb":{var n=LoadImage(r);var i=n.pageInfo,g=n.rowData;var l=resize(i.width,i.height,200,200);var f=Math.round(l.w);var m=Math.round(l.h);var o=new Uint8Array(f*m*4);resample_hermite(g,o,i.width,i.height,f,m);var b=null;postMessage({cmd:a,id:t,bytearray:o,xsize:f,ysize:m,pagearray:b,pageInfo:i,maketime:(Date.now()-last_ms)/1e3});b=null;IWSImageLib._free(g.byteOffset);g=null}break;case"loadpage":{var n=LoadImage(r);var i=n.pageInfo,g=n.rowData;var b=new Uint8Array(g.byteLength);b.set(g);postMessage({cmd:a,id:t,pagearray:b,pageInfo:i,maketime:(Date.now()-last_ms)/1e3});b=null;IWSImageLib._free(g.byteOffset);g=null}break;case"savepage":{var v=e.data.format;var I=0,h=1,d=2,y=3,c=4,u=5,w=6,p=7;var L=0,_=2,S=3,W=4,D=5,k=6,x=7,A=32773;var n=LoadImage(r);var i=n.pageInfo,g=n.rowData;var M=new IWSImageLib.CIWSImageWeb;var U=0;var O=100;switch(v){case h:U=L;O=100;break;case d:O=20;break;case y:O=20;if(i.bpp===1)U=W;else U=x;break;case c:O=20;break;case u:O=20;break;case w:break;case p:break}var E=M.EncodeImage(g.byteOffset,g.byteLength,i.width,i.height,i.bpp,i.xres,i.yres,v,U,O,t.angle);IWSImageLib._free(g.byteOffset);g=null;var C=null;var G=false;if(E==1){var H=M.GetImageSize();var z=IWSImageLib._malloc(H);saveData=new Uint8ClampedArray(IWSImageLib.HEAPU8.buffer,z,H);var P=M.GetImageData(saveData.byteOffset);if(P==1){C=new Uint8Array(saveData.byteLength);C.set(saveData);G=true;M.EncodeClose()}IWSImageLib._free(z);z=null}postMessage({cmd:a,id:t,filearray:C,success:G,maketime:(Date.now()-last_ms)/1e3});C=null;M=null}break;default:console.log("Don't know command.");break}};