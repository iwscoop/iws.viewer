var last_ms=Date.now();importScripts("./IWSTiffSplitLib_min.js");var importtime=(Date.now()-last_ms)/1e3+" Seconds";console.log("Load thumbnail importScripts('IWSTiffSplitLib_min.js') time is "+importtime);self.addEventListener("message",onmessage,false);onmessage=function(e){var r=e.data.cmd;var t=e.data.buffer;switch(r){case"split":{var a=[];var f=IWSTiffSplitLib;var i=f._malloc(t.byteLength);var n=new Uint8Array(f.HEAPU8.buffer,i,t.byteLength);n.set(new Uint8Array(t));var l=new f.CIWSTiffSplitWeb;if(l.Open(n.byteOffset,n.byteLength)===1){var s=l.PageCount();for(var o=0;o<s;o++){var b=l.GetPageBuffSize(o);var v=f._malloc(b);var S=new Uint8Array(f.HEAPU8.buffer,v,b);l.GetPageCopy(o,S.byteOffset);var m=new Uint8Array(b);m.set(S);a.push({index:o,buffer:m});f._free(S.byteOffset);S=null}l.Close()}else{a.push({index:0,buffer:t})}l=null;f._free(i);l=null;postMessage({cmd:r,bufferarray:a})}break;case"merge":{var l=new IWSTiffSplitLib.CIWSTiffMergeWeb;var p=l.Open();if(p===1){for(var o=0;o<t.length;o++){var g=t[o].id;var y=t[o].filearray;var u=IWSTiffSplitLib._malloc(y.length);var c=new Uint8Array(IWSTiffSplitLib.HEAPU8.buffer,u,y.length);c.set(new Uint8Array(y));var L=l.MergeImage(c.byteOffset,c.byteLength);console.log("bMerge = "+L);IWSTiffSplitLib._free(u);u=null}var d=l.GetTiffSize();var w=IWSTiffSplitLib._malloc(d);var T=new Uint8Array(IWSTiffSplitLib.HEAPU8.buffer,w,d);l.GetTiffCopy(T.byteOffset);var m=new Uint8Array(d);m.set(T);postMessage({cmd:r,bufferarray:m});IWSTiffSplitLib._free(w);l.Close()}l=null}break;default:console.log("Don't know command.");break}};